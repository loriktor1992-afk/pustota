<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PUSTOTA</title>
  <style>
    body { margin:0; background:#111; overflow:hidden; touch-action:none; font-family:sans-serif; color:#fff; }
    canvas { display:block; }
    #ui { position:absolute; top:15px; left:15px; z-index:10; background:rgba(0,0,0,0.8); padding:15px; border-radius:15px; font-size:14px; }
  </style>
</head>
<body>
  <div id="ui">
    Масса: <span id="mass">10</span>л<br>
    Размер: <span id="radius">20</span>px<br>
    Скорость: <span id="speed">1.0</span>
  </div>
  <canvas id="game"></canvas>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Футбольное поле ~105x68м, масштаб 1м = 10px → поле 1050x680px, центр на экране
    const FIELD_WIDTH = 1050;
    const FIELD_HEIGHT = 680;
    const FIELD_X = (canvas.width - FIELD_WIDTH) / 2;
    const FIELD_Y = (canvas.height - FIELD_HEIGHT) / 2;

    // Физика
    const DENSITY = 1;  // 1л = 1 кг
    const PI = Math.PI;

    function massToRadius(mass) {
      // V = 4/3 π r^3 = mass
      return Math.cbrt((3 * mass) / (4 * PI)) * 10;  // Масштаб: 10л = r~20px
    }

    function radiusToMass(radius) {
      return (4 / 3 * PI * Math.pow(radius / 10, 3));
    }

    // Игрок
    let player = {
      x: FIELD_WIDTH / 2 + FIELD_X,
      y: FIELD_HEIGHT / 2 + FIELD_Y,
      mass: 10,  // Футбольный мяч ~10л
      vx: 0,
      vy: 0,
      speed: 3.0  // Умеренная скорость
    };
    player.radius = massToRadius(player.mass);

    // Корм (1л)
    let food = [];
    function spawnFood() {
      food.push({
        x: FIELD_X + Math.random() * FIELD_WIDTH,
        y: FIELD_Y + Math.random() * FIELD_HEIGHT,
        mass: 1,
        radius: massToRadius(1)
      });
    }

    // Враги (случайная масса 1-5л)
    let enemies = [];
    function spawnEnemy() {
      enemies.push({
        x: FIELD_X + Math.random() * FIELD_WIDTH,
        y: FIELD_Y + Math.random() * FIELD_HEIGHT,
        mass: 1 + Math.random() * 4,
        vx: (Math.random() - 0.5) * 2,
        vy: (Math.random() - 0.5) * 2,
        speed: 2.5
      });
    }

    // Спавн начальный
    for (let i = 0; i < 50; i++) spawnFood();
    for (let i = 0; i < 10; i++) spawnEnemy();

    // Джойстик (левый нижний угол)
    let joystick = {
      active: false,
      x: 100,
      y: canvas.height - 150,
      r: 60,
      dx: 0,
      dy: 0
    };

    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const tx = touch.clientX - rect.left;
      const ty = touch.clientY - rect.top;
      const dist = Math.sqrt((tx - joystick.x)**2 + (ty - joystick.y)**2);
      if (dist < joystick.r) {
        joystick.active = true;
      }
    });

    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      if (!joystick.active) return;
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const tx = touch.clientX - rect.left;
      const ty = touch.clientY - rect.top;
      joystick.dx = (tx - joystick.x) / joystick.r;
      joystick.dy = (ty - joystick.y) / joystick.r;
      const mag = Math.sqrt(joystick.dx**2 + joystick.dy**2);
      if (mag > 1) {
        joystick.dx /= mag;
        joystick.dy /= mag;
      }
    });

    canvas.addEventListener('touchend', e => {
      e.preventDefault();
      joystick.active = false;
      joystick.dx = 0;
      joystick.dy = 0;
    });

    // Мышь для ПК
    let mouseDown = false;
    canvas.addEventListener('mousedown', () => mouseDown = true);
    canvas.addEventListener('mouseup', () => mouseDown = false);
    canvas.addEventListener('mousemove', e => {
      if (mouseDown) {
        const rect = canvas.getBoundingClientRect();
        const tx = e.clientX - rect.left;
        const ty = e.clientY - rect.top;
        joystick.dx = (tx - joystick.x) / joystick.r;
        joystick.dy = (ty - joystick.y) / joystick.r;
        const mag = Math.sqrt(joystick.dx**2 + joystick.dy**2);
        if (mag > 1) {
          joystick.dx /= mag;
          joystick.dy /= mag;
        }
      }
    });

    // Обновление позиции игрока
    function updatePlayer() {
      player.vx = joystick.dx * player.speed;
      player.vy = joystick.dy * player.speed;
      player.x += player.vx;
      player.y += player.vy;

      // Границы поля
      player.x = Math.max(player.radius, Math.min(FIELD_WIDTH - player.radius + FIELD_X, player.x));
      player.y = Math.max(player.radius, Math.min(FIELD_HEIGHT - player.radius + FIELD_Y, player.y));

      // Скорость обратно пропорциональна массе (как в Agar.io)
      player.speed = 4.0 / (1 + player.mass / 50);
    }

    // Коллизии
    function checkCollisions() {
      // Корм
      for (let i = food.length - 1; i >= 0; i--) {
        const f = food[i];
        const dist = Math.sqrt((player.x - f.x)**2 + (player.y - f.y)**2);
        if (dist < player.radius + f.radius) {
          player.mass += f.mass;
          player.radius = massToRadius(player.mass);
          food.splice(i, 1);
        }
      }

      // Враги
      for (let i = enemies.length - 1; i >= 0; i--) {
        const enemy = enemies[i];
        enemy.radius = massToRadius(enemy.mass);
        const dist = Math.sqrt((player.x - enemy.x)**2 + (player.y - enemy.y)**2);
        if (dist < player.radius + enemy.radius) {
          if (player.mass > enemy.mass * 1.1) {
            // Съел врага полностью
            player.mass += enemy.mass;
            player.radius = massToRadius(player.mass);
            enemies.splice(i, 1);
          } else if (enemy.mass > player.mass * 1.1) {
            // Враг съел тебя (respawn)
            player.mass = 10;
            player.radius = massToRadius(10);
            player.x = FIELD_WIDTH / 2 + FIELD_X;
            player.y = FIELD_HEIGHT / 2 + FIELD_Y;
          }
        }
      }
    }

    // Спавн
    setInterval(spawnFood, 2000);  // Корм каждые 2 сек
    setInterval(spawnEnemy, 5000);  // Враг каждые 5 сек

    // Анимация
    function loop() {
      updatePlayer();
      checkCollisions();

      // Фон поля
      ctx.fillStyle = '#228B22';
      ctx.fillRect(FIELD_X, FIELD_Y, FIELD_WIDTH, FIELD_HEIGHT);

      // Игрок
      ctx.beginPath();
      ctx.arc(player.x, player.y, player.radius, 0, 2 * PI);
      ctx.fillStyle = '#00ff88';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Джойстик
      ctx.save();
      ctx.translate(joystick.x, joystick.y);
      ctx.beginPath();
      ctx.arc(0, 0, joystick.r, 0, 2 * PI);
      ctx.fillStyle = 'rgba(255,255,255,0.2)';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(joystick.dx * joystick.r * 0.6, joystick.dy * joystick.r * 0.6, joystick.r * 0.4, 0, 2 * PI);
      ctx.fillStyle = '#00ff99';
      ctx.fill();
      ctx.restore();

      // Корм (жёлтые точки)
      ctx.fillStyle = '#ffdd00';
      food.forEach(f => {
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.radius, 0, 2 * PI);
        ctx.fill();
      });

      // Враги (красные)
      ctx.fillStyle = '#ff4444';
      enemies.forEach(enemy => {
        ctx.beginPath();
        ctx.arc(enemy.x, enemy.y, enemy.radius, 0, 2 * PI);
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 1;
        ctx.stroke();
      });

      // UI
      document.getElementById('mass').textContent = Math.floor(player.mass);
      document.getElementById('radius').textContent = Math.floor(player.radius);
      document.getElementById('speed').textContent = player.speed.toFixed(1);

      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
