const WebSocket = require('ws');
const http = require('http');

const server = http.createServer((req, res) => {
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  res.end('PUSTOTA Server Running!');
});

const wss = new WebSocket.Server({ server });

let players = {};

wss.on('connection', ws => {
  const id = Math.random().toString(36).substr(2, 9);
  players[id] = { x: Math.random() * 800 + 100, y: Math.random() * 600 + 100, size: 50, name: 'Player' };
  
  ws.send(JSON.stringify({ type: 'init', id }));

  ws.on('message', data => {
    try {
      const msg = JSON.parse(data);
      if (msg.type === 'move' && players[id]) {
        players[id].x = Math.max(50, Math.min(window.innerWidth - 50, msg.x));
        players[id].y = Math.max(50, Math.min(window.innerHeight - 50, msg.y));
      }
    } catch(e) {}
  });

  ws.on('close', () => delete players[id]);
});

setInterval(() => {
  // Простая логика еды: большие едят маленьких
  Object.keys(players).forEach(id1 => {
    Object.keys(players).forEach(id2 => {
      if (id1 !== id2) {
        const p1 = players[id1];
        const p2 = players[id2];
        const dist = Math.sqrt((p1.x - p2.x)**2 + (p1.y - p2.y)**2);
        if (dist < p1.size + p2.size && p1.size > p2.size * 1.1) {
          p1.size += p2.size * 0.5;
          delete players[id2];
        }
      }
    });
  });

  wss.clients.forEach(client => {
    if (client.readyState === WebSocket.OPEN) {
      client.send(JSON.stringify({ type: 'update', players }));
    }
  });
}, 100);  // 10 FPS для PvP

server.listen(process.env.PORT || 8080, () => {
  console.log('PUSTOTA SERVER RUNNING on port ' + (process.env.PORT || 8080));
});
