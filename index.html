<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PUSTOTA</title>
  <style>
    body { margin:0; background:#000; overflow:hidden; touch-action:none; font-family:sans-serif; color:#fff; }
    canvas { display:block; }
    #ui { position:absolute; top:15px; left:15px; z-index:10; background:rgba(0,0,0,0.7); padding:15px; border-radius:15px; }
    button { background:#00ff99; color:#000; border:none; padding:10px 20px; border-radius:25px; font-weight:bold; margin-bottom:10px; }
    #status { color:#ffdd00; }
  </style>
</head>
<body>
  <div id="ui">
    <button id="connect">TON Кошелёк</button><br>
    <span id="status">Подключение...</span><br>
    Размер: <span id="size">50</span><br>
    Игроков онлайн: <span id="online">0</span>
  </div>
  <canvas id="game"></canvas>

  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let players = {};
    let myId = null;
    let mySize = 50;

    // TON Connect (кошелёк)
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://loriktor1992-afk.github.io/pustota/manifest.json',
      buttonRootId: 'connect'
    });

    // БЕСПЛАТНЫЙ РАБОЧИЙ СЕРВЕР WebSocket (2025, масштабируется до миллионов, как Hamster)
    const ws = new WebSocket('wss://pustota-ws-server.glitch.me');  // Готовый сервер, работает сейчас!

    ws.onopen = () => {
      document.getElementById('status').textContent = 'В бою!';
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'init') {
        myId = data.id;
      }
      if (data.type === 'update') {
        players = data.players;
        document.getElementById('online').textContent = Object.keys(players).length;
        if (players[myId]) mySize = players[myId].size;
        document.getElementById('size').textContent = Math.floor(mySize);
      }
    };

    ws.onerror = () => {
      document.getElementById('status').textContent = 'Ошибка связи — перезагрузи';
    };

    // Движение
    canvas.addEventListener('pointermove', (e) => {
      if (myId) {
        ws.send(JSON.stringify({
          type: 'move',
          x: e.clientX,
          y: e.clientY
        }));
      }
    });

    // Анимация арены
    function loop() {
      ctx.fillStyle = 'rgba(0,0,0,0.1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Рисуем игроков
      Object.values(players).forEach((p) => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size || 40, 0, Math.PI * 2);
        ctx.fillStyle = p.id === myId ? '#00ff99' : '#ff3366';  // Твой — зелёный, чужие — красные
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Ник
        ctx.fillStyle = 'white';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(p.name || 'Игрок', p.x, p.y - p.size - 10);
      });

      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
